# -*- coding: utf-8 -*-
"""app

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZLYYVt6ChMmY-gc202FfiWt5-n9vxYCm
"""
import gradio as gr
import os
import requests
import pdfplumber
from dotenv import load_dotenv

# Configura√ß√£o da API
load_dotenv()
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY")
API_URL = "https://openrouter.ai/api/v1/chat/completions"
HEADERS = {
    "Authorization": f"Bearer {OPENROUTER_API_KEY}",
    "Content-Type": "application/json"
}
MODEL = "mistralai/mistral-7b-instruct"

# Modelo de curr√≠culo de refer√™ncia
MODELO_DEMO = """
MARIA SILVA
(11) 98765-4321 | maria.silva@email.com | S√£o Paulo/SP
LinkedIn: linkedin.com/in/mariasilva
OBJETIVO
Gerente de Log√≠stica
## RESUMO DE QUALIFICA√á√ïES
- 8+ anos em gest√£o log√≠stica
- Especialista em SAP e Power BI
- Redu√ß√£o de custos log√≠sticos em 30% na empresa anterior
- Certifica√ß√£o Lean Six Sigma
## EXPERI√äNCIA PROFISSIONAL
- Gerente de Log√≠stica - Empresa XYZ | 2020-Presente
- Gerenciou equipe de 15 pessoas, reduzindo atrasos em 25%
- Implementou novo sistema WMS, aumentando efici√™ncia em 40%
- Negociou contratos com transportadoras, economizando R$ 1,2M/ano
### Analista S√™nior - Empresa ABC | 2015-2020
- Automatizou relat√≥rios, reduzindo tempo de an√°lise em 70%
- Coordenou projeto de redistribui√ß√£o de estoques
## FORMA√á√ÉO
- Administra√ß√£o - USP (2014)
- P√≥s-gradua√ß√£o em Supply Chain - FGV (2016)
## HABILIDADES
- SAP Log√≠stico (Avan√ßado)
- Power BI (Intermedi√°rio)
- Ingl√™s Fluente
"""

# Extrai o texto do PDF
def extract_text(file):
    try:
        with pdfplumber.open(file.name) as pdf:
            return "\n".join([page.extract_text() for page in pdf.pages if page.extract_text()])
    except Exception as e:
        raise gr.Error(f"Erro ao ler o PDF: {str(e)}")

# Chama a API da IA com tratamento de erro
def call_llm(prompt, system_role):
    try:
        response = requests.post(API_URL, headers=HEADERS, json={
            "model": MODEL,
            "messages": [
                {"role": "system", "content": system_role},
                {"role": "user", "content": prompt}
            ]
        })

        if response.status_code != 200:
            return f"‚ùå Erro da API ({response.status_code}): {response.text}"

        data = response.json()

        if "choices" in data and data["choices"]:
            return data["choices"][0]["message"]["content"]
        else:
            return f"‚ùå Erro: resposta inesperada da API:\n{data}"

    except Exception as e:
        return f"‚ùå Erro na chamada da IA: {str(e)}"

# Prompt otimizado para an√°lise ATS
def gerar_prompt_avaliacao(texto):
    return f"""
Voc√™ √© um recrutador especialista em an√°lise de curr√≠culos para sistemas de triagem autom√°tica (ATS), como Gupy, Kenoby e similares.
Recebeu o seguinte curr√≠culo:
--- IN√çCIO DO CURR√çCULO ---
{texto}
--- FIM DO CURR√çCULO ---
Sua tarefa √© gerar um relat√≥rio completo, claro e pr√°tico contendo:
1. ‚úÖ An√°lise ATS Detalhada
   - O curr√≠culo est√° bem formatado para leitura autom√°tica?
   - As palavras-chave mais importantes para a √°rea est√£o presentes?
   - H√° se√ß√µes obrigat√≥rias faltando (Resumo, Experi√™ncia, Habilidades, etc)?
   - Existem erros ou excessos que podem prejudicar a triagem?
2. üìä Pontua√ß√£o (0-100)
   - Adapta√ß√£o para ATS: XX/100
   - Clareza e Leitura por Humanos: XX/100
3. üìå Recomenda√ß√µes Pr√°ticas
   - O que falta para aumentar as chances de passar em sistemas ATS?
   - Que palavras-chave, compet√™ncias ou m√©tricas poderiam ser adicionadas?
   - Sugira tamb√©m melhorias espec√≠ficas por se√ß√£o (Resumo, Experi√™ncia, etc.)
4. üí° Resumo Final em T√≥picos
   - Pontos fortes
   - Pontos de aten√ß√£o
   - A√ß√µes imediatas para melhorar o curr√≠culo
"""

# Fun√ß√£o para analisar curr√≠culo
def analisar_curriculo(file):
    texto = extract_text(file)
    prompt = gerar_prompt_avaliacao(texto)
    resultado = call_llm(prompt, "Voc√™ √© um especialista em recrutamento t√©cnico.")
    caminho = salvar_txt(resultado, "analise_curriculo.txt")
    return resultado, caminho

# Fun√ß√£o para melhorar curr√≠culo
def melhorar_curriculo(file):
    texto = extract_text(file)
    prompt = f"""
Melhore este curr√≠culo com base no seguinte modelo:
{MODELO_DEMO}
Texto original:
{texto}
Regras:
1. Mantenha todas as informa√ß√µes
2. Use a estrutura do modelo
3. Adicione m√©tricas sempre que poss√≠vel
4. Responda em formato markdown
"""
    resultado = call_llm(prompt, "Voc√™ √© um revisor de curr√≠culos profissional.")
    caminho = salvar_txt(resultado, "curriculo_otimizado.txt")
    return resultado, caminho

# Salva sa√≠da como arquivo
def salvar_txt(conteudo, nome_arquivo):
    caminho = f"/tmp/{nome_arquivo}"
    with open(caminho, "w", encoding="utf-8") as f:
        f.write(conteudo)
    return caminho

# Interface Gradio
with gr.Blocks(title="Otimizador de Curr√≠culo Pro") as app:
    gr.HTML("<h1 style='text-align: center; color: #1f77b4;'>Otimizador Profissional de Curr√≠culos</h1>")

    with gr.Tabs():
        with gr.Tab("An√°lise para Gupy"):
            file_input1 = gr.File(label="Envie seu curr√≠culo em PDF", file_types=[".pdf"])
            btn1 = gr.Button("Analisar Curr√≠culo")
            resultado1 = gr.Textbox(label="Resultado da An√°lise", lines=25)
            download1 = gr.File(label="Baixar Resultado")
            btn1.click(analisar_curriculo, inputs=[file_input1], outputs=[resultado1, download1])

        with gr.Tab("Melhorar Curr√≠culo"):
            file_input2 = gr.File(label="Envie seu curr√≠culo em PDF", file_types=[".pdf"])
            btn2 = gr.Button("Melhorar Curr√≠culo")
            resultado2 = gr.Textbox(label="Curr√≠culo Otimizado", lines=25)
            download2 = gr.File(label="Baixar Curr√≠culo")
            btn2.click(melhorar_curriculo, inputs=[file_input2], outputs=[resultado2, download2])

        with gr.Tab("Modelo Ideal"):
            modelo = gr.Textbox(value=MODELO_DEMO.strip(), label="Modelo Padr√£o de Curr√≠culo", lines=25, interactive=False)

if __name__ == "__main__":
    app.launch(server_name="0.0.0.0", server_port=7860)

